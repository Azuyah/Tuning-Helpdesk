<!-- views/admin-question.ejs -->
<section id="qView" data-qid="<%= q.id %>" class="mx-auto max-w-4xl px-4 py-10">
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-bold text-slate-900">Fråga #<%= q.id %></h1>
    <a href="/admin"
       class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-50">
      <i class="ti ti-arrow-left"></i> Tillbaka
    </a>
  </div>

  <!-- Info-kort -->
  <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
    <div class="flex flex-wrap items-center gap-3 mb-2">
      <% 
  const statusCls =
    q.status === 'open' ? 'bg-emerald-50 text-emerald-700 border border-emerald-200'
  : q.status === 'answered' ? 'bg-sky-50 text-sky-700 border border-sky-200'
  : 'bg-slate-50 text-slate-700 border border-slate-200';
      %>
      <span class="text-sm rounded-full px-2 py-1 <%= statusCls %>">
        <% 
  const statusLabels = {
    open: "Öppen",
    answered: "Besvarad",
    closed: "Stängd"
  };
%>
Status: <%= statusLabels[q.status] || q.status %>
      </span>
      <span class="text-sm text-slate-500">
        Skapad: <%= new Date(q.created_at).toLocaleString('sv-SE') %>
      </span>
      <% if (q.updated_at) { %>
        <span class="text-sm text-slate-500">
          Uppdaterad: <%= new Date(q.updated_at).toLocaleString('sv-SE') %>
        </span>
      <% } %>
    </div>

    <h2 class="text-xl font-semibold text-slate-900"><%= q.title %></h2>

    <% if (q.body) { %>
      <p class="mt-3 text-slate-700 whitespace-pre-line"><%= q.body %></p>
    <% } %>

    <div class="mt-4 text-sm text-slate-600">
      Från:
      <span class="font-medium"><%= q.user_name || '' %></span>
      <% if (q.user_email) { %>&lt;<%= q.user_email %>&gt;<% } %>
    </div>
  </div>

<!-- Åtgärder – ny layout: formulär till vänster, status/verktyg till höger -->
<section class="mx-auto max-w-6xl px-4 py-10 grid lg:grid-cols-3 gap-8">

  <!-- Vänster: frågekort + formulär -->
  <div class="lg:col-span-2 space-y-8">

    <!-- Frågekortet ligger redan ovanför här -->

    <!-- Svara och publicera (bredare) -->
    <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
      <h3 class="font-semibold text-slate-900 mb-3">Svara och publicera</h3>
      <form method="POST" action="/admin/questions/<%= q.id %>/answer" class="space-y-4">

        <div>
          <label class="block text-sm font-medium text-slate-700">Ditt svar</label>
          <textarea name="body" rows="8" required
                    class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 shadow-sm
                           focus:border-sky-500 focus:ring-sky-500 sm:text-sm"></textarea>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700">Taggar (komma-separerade)</label>
          <input name="tags" placeholder="ex: autotuner, virtual read, credits"
                 class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 shadow-sm
                        focus:border-sky-500 focus:ring-sky-500 sm:text-sm"/>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700">Kategori</label>
          <div class="relative mt-1">
            <select name="categoryId"
                    class="w-full rounded-lg border border-slate-300 px-3 py-2 shadow-sm
                           focus:border-sky-500 focus:ring-sky-500 sm:text-sm bg-white appearance-none">
              <option value="">— Välj kategori —</option>
              <% (categories || []).forEach(function(c){ %>
                <option value="<%= c.id %>"><%= c.title %></option>
              <% }); %>
            </select>
            <i class="ti ti-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none"></i>
          </div>
        </div>

        <div class="pt-2">
          <button type="submit"
                  class="inline-flex items-center gap-2 rounded-lg bg-sky-600 px-5 py-2 text-white font-medium shadow-sm hover:bg-sky-700">
            Publicera svar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Höger: status och koppla ämne -->
  <aside class="space-y-6">

    <!-- Ändra status -->
    <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
      <h3 class="font-semibold text-slate-900 mb-3">Ändra status</h3>
      <div class="flex flex-wrap gap-2">
        <button type="button" data-status="open"
          class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-50">Öppen</button>
        <button type="button" data-status="answered"
          class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-50">Besvarad</button>
        <button type="button" data-status="closed"
          class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-50">Stängd</button>
      </div>
    </div>

    <!-- Koppla ämne -->
    <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
      <h3 class="font-semibold text-slate-900 mb-3">Koppla ämne</h3>
      <div class="relative">
        <input id="topicSearch" type="search" placeholder="Sök ämne…"
               class="w-full rounded-lg border border-slate-300 px-3 py-2 shadow-sm focus:border-sky-500 focus:ring-sky-500"/>
        <div id="suggestBox"
             class="absolute z-10 mt-2 w-full bg-white border border-slate-200 rounded-xl shadow-lg hidden overflow-hidden"></div>
      </div>

      <% if (linked && linked.length) { %>
        <div class="mt-4">
          <div class="text-sm text-slate-600 mb-2">Kopplade ämnen:</div>
          <ul class="space-y-1">
            <% linked.forEach(function(t){ %>
              <li>
                <a href="/topic/<%= t.id %>" class="text-sky-600 hover:underline"><%= t.title %></a>
              </li>
            <% }); %>
          </ul>
        </div>
      <% } %>
    </div>

  </aside>
</section>

<!-- Snackbar (lämna kvar) -->
<div id="snack"
     class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden rounded-lg border px-4 py-2 text-sm shadow"></div>
</section>

<script>
(function(){
  // Hämta fråga-id utan EJS i JS (bättre för linters)
  var root = document.getElementById('qView');
  var qid  = Number(root && root.dataset.qid);

  var snack = document.getElementById('snack');
  function toast(text, ok) {
    if (ok === void 0) ok = true;
    snack.textContent = text;
    snack.className =
      'fixed bottom-4 left-1/2 -translate-x-1/2 rounded-lg px-4 py-2 text-sm shadow ' +
      (ok
        ? 'bg-emerald-50 text-emerald-800 border border-emerald-200'
        : 'bg-red-50 text-red-800 border border-red-200');
    snack.classList.remove('hidden');
    setTimeout(function(){ snack.classList.add('hidden'); }, 2000);
  }

  // Byt status
  var statusBtns = document.querySelectorAll('[data-status]');
  statusBtns.forEach(function(btn){
    btn.addEventListener('click', function(){
      var status = btn.getAttribute('data-status');
      fetch('/api/questions/' + qid + '/status', {
        method: 'PUT',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ status: status })
      })
      .then(function(res){ return res.json().then(function(d){ return { ok: res.ok, data: d }; }); })
      .then(function(resp){
        if (!resp.ok) throw new Error(resp.data && resp.data.error || 'Fel');
        toast('Status uppdaterad');
        location.reload();
      })
      .catch(function(){ toast('Kunde inte uppdatera status', false); });
    });
  });

  // Autosuggest + koppla ämne
  var input = document.getElementById('topicSearch');
  var box   = document.getElementById('suggestBox');
  var timer = null;

  function escapeHtml(s){
    return (s || '').replace(/[&<>"']/g, function(m){
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]);
    });
  }

  function renderSuggest(rows){
    if (!rows || !rows.length){
      box.classList.add('hidden');
      box.innerHTML = '';
      return;
    }
    var html = rows.map(function(r){
      var t = escapeHtml(r.title || '');
      var sn = r.snippet ? '<div class="text-sm text-slate-600">' + escapeHtml(r.snippet) + '</div>' : '';
      return (
        '<button type="button" data-id="' + r.id + '" class="w-full text-left px-4 py-3 hover:bg-slate-50">' +
          '<div class="font-medium text-slate-900">' + t + '</div>' +
          sn +
        '</button>'
      );
    }).join('');
    box.innerHTML = html;
    box.classList.remove('hidden');
  }

  function fetchSuggest(q){
    if (!q) { renderSuggest([]); return; }
    fetch('/api/suggest?q=' + encodeURIComponent(q))
      .then(function(res){ return res.json(); })
      .then(function(rows){ renderSuggest(Array.isArray(rows) ? rows : []); })
      .catch(function(){ /* tyst fel */ });
  }

  if (input){
    input.addEventListener('input', function(){
      clearTimeout(timer);
      var q = input.value.trim();
      timer = setTimeout(function(){ fetchSuggest(q); }, 150);
    });
    document.addEventListener('click', function(e){
      if (!e.target.closest('#suggestBox') && e.target !== input) box.classList.add('hidden');
    });
  }

  // Koppla ämne (klick i suggestBox)
  if (box){
    box.addEventListener('click', function(e){
      var btn = e.target.closest('button[data-id]');
      if (!btn) return;
      var topicId = btn.getAttribute('data-id');
      fetch('/api/questions/' + qid + '/attach-topic', {
        method: 'PUT',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ topicId: topicId })
      })
      .then(function(res){ return res.json().then(function(d){ return { ok: res.ok, data: d }; }); })
      .then(function(resp){
        if (!resp.ok) throw new Error(resp.data && resp.data.error || 'Fel');
        toast('Ämne kopplat');
        location.reload();
      })
      .catch(function(){ toast('Kunde inte koppla ämne', false); });
    });
  }
})();
</script>