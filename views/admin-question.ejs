<!-- views/admin-question.ejs -->
<section id="qView" data-qid="<%= q.id %>" class="mx-auto max-w-6xl px-4 py-10 grid lg:grid-cols-3 gap-8">
  <!-- Vänsterkolumn -->
  <div class="lg:col-span-2 space-y-8">
    <!-- Frågekort -->
    <article class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
      <div class="flex flex-wrap items-center gap-3 mb-2">
        <%
          const statusCls =
            q.status === 'open'     ? 'bg-emerald-50 text-emerald-700 border border-emerald-200' :
            q.status === 'answered' ? 'bg-sky-50 text-sky-700 border border-sky-200' :
                                      'bg-slate-50 text-slate-700 border border-slate-200';
          const statusLabels = { open: 'Öppen', answered: 'Besvarad', closed: 'Stängd' };
        %>
        <span class="text-sm rounded-full px-2 py-1 <%= statusCls %>">
          Status: <%= statusLabels[q.status] || q.status %>
        </span>
        <span class="text-sm text-slate-500">
          Skapad: <%= new Date(q.created_at).toLocaleString('sv-SE') %>
        </span>
        <% if (q.updated_at) { %>
          <span class="text-sm text-slate-500">
            Uppdaterad: <%= new Date(q.updated_at).toLocaleString('sv-SE') %>
          </span>
        <% } %>
      </div>

      <h2 class="text-xl font-semibold text-slate-900"><%= q.title %></h2>

      <% if (q.body) { %>
        <p class="mt-3 text-slate-700 whitespace-pre-line"><%= q.body %></p>
      <% } %>

      <div class="mt-4 text-sm text-slate-600">
        Från:
        <span class="font-medium"><%= q.user_name || '' %></span>
        <% if (q.user_email) { %>&lt;<%= q.user_email %>&gt;<% } %>
      </div>
    </article>

    <!-- Svara på frågan -->
    <article class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold text-slate-900">Svara på frågan</h3>
        <% if (q.answered_at) { %>
          <span class="text-xs text-slate-500">Senast besvarad: <%= new Date(q.answered_at).toLocaleString('sv-SE') %></span>
        <% } %>
      </div>

      <form method="POST" action="/admin/questions/<%= q.id %>" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700">Svarsrubrik</label>
          <input
            type="text"
            name="answer_title"
            value="<%= q.answer_title || ('Svar: ' + q.title) %>"
            class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 shadow-sm
                   focus:border-sky-500 focus:ring-sky-500 sm:text-sm" />
        </div>

<div>
  <label class="block text-sm font-medium text-slate-700">Ditt svar</label>
  <textarea id="answerEditor" name="answer_body" rows="10"><%= q.answer_body || '' %></textarea>
  <p class="text-xs text-slate-500 mt-1">
    HTML tillåts och saneras server-side (t.ex. <code>&lt;p&gt;</code>, listor, länkar).
  </p>
</div>

        <div>
          <label class="block text-sm font-medium text-slate-700">Taggar (valfritt, komma-separerade)</label>
          <input
            name="answer_tags"
            value="<%= q.answer_tags || '' %>"
            placeholder="ex: b48, 330e, ecu"
            class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 shadow-sm
                   focus:border-sky-500 focus:ring-sky-500 sm:text-sm" />
        </div>

        <div class="pt-2 flex items-center gap-3">
          <button type="submit"
                  class="inline-flex items-center gap-2 rounded-lg bg-sky-600 px-5 py-2 text-white font-medium shadow-sm hover:bg-sky-700">
            <i class="ti ti-device-floppy"></i> Spara svar
          </button>

          <% if (q.is_answered) { %>
            <span class="text-sm text-slate-500">Besvarad av <%= q.answered_by || 'Okänd' %></span>
          <% } %>
        </div>
      </form>
    </article>
  </div>

  <!-- Högerkolumn -->
  <aside class="space-y-6">
    <!-- Ändra status -->
    <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
      <h3 class="font-semibold text-slate-900 mb-3">Ändra status</h3>
      <div class="flex flex-wrap gap-2">
        <button type="button" data-status="open"
          class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-50">Öppen</button>
        <button type="button" data-status="answered"
          class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-50">Besvarad</button>
        <button type="button" data-status="closed"
          class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-50">Stängd</button>
      </div>
    </div>

<!-- Koppla ämne (max 1 kopplat) -->
<div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
  <h3 class="font-semibold text-slate-900 mb-3">Koppla ämne</h3>

  <div class="relative">
    <input id="topicSearch" type="search" placeholder="Sök ämne…"
           class="w-full rounded-lg border border-slate-300 px-3 py-2 shadow-sm focus:border-sky-500 focus:ring-sky-500"/>
    <div id="suggestBox"
         class="absolute z-10 mt-2 w-full bg-white border border-slate-200 rounded-xl shadow-lg hidden overflow-hidden"></div>
  </div>

  <div class="mt-4">
    <div class="text-sm text-slate-600 mb-2">Kopplat ämne:</div>
    <% if (linked && linked.length) { 
         const t = linked[0]; %>
      <div class="flex items-center justify-between gap-3 rounded-lg border border-slate-200 px-3 py-2">
        <a href="/topic/<%= t.id %>" class="text-sky-600 hover:underline"><%= t.title %></a>
        <button type="button" id="btnChangeTopic"
                class="text-xs rounded-md border border-slate-300 px-2 py-1 hover:bg-slate-50">Byt</button>
      </div>
    <% } else { %>
      <div class="rounded-lg border border-dashed border-slate-300 px-3 py-2 text-sm text-slate-500">
        Inget ämne kopplat ännu.
      </div>
    <% } %>
  </div>
</div>

    <!-- Kategorier för frågan -->
<div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
  <h3 class="font-semibold text-slate-900 mb-3">Kategori</h3>

  <% if (!categories || categories.length === 0) { %>
    <p class="text-sm text-slate-500">Inga kategorier skapade ännu.</p>
  <% } else { 
       const selectedCatId = Array.isArray(qCategoryIds) && qCategoryIds.length ? String(qCategoryIds[0]) : '';
  %>
    <form id="catForm" class="space-y-3">
      <div class="relative">
        <select id="catSelect" name="category_id"
                class="w-full rounded-lg border border-slate-300 px-3 py-2 shadow-sm sm:text-sm
                       focus:border-sky-500 focus:ring-sky-500 appearance-none">
          <option value="">— Välj kategori —</option>
          <% categories.forEach(function(c){ %>
            <option value="<%= c.id %>" <%= String(c.id)===selectedCatId ? 'selected' : '' %>><%= c.title %></option>
          <% }) %>
        </select>
        <i class="ti ti-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none"></i>
      </div>

      <button type="button" id="btnSaveCat"
              class="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-sky-600 px-4 py-2 text-white font-medium shadow-sm hover:bg-sky-700">
        <i class="ti ti-device-floppy"></i> Spara kategori
      </button>
    </form>
  <% } %>
</div>

    <!-- Ta bort fråga -->
    <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
      <form method="POST"
            action="/admin/questions/<%= q.id %>/delete"
            data-del-form
            data-title="<%- (q.title || '').replace(/\"/g,'&quot;') %>">
        <button type="submit"
                class="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-red-600 px-4 py-2 text-white font-medium shadow-sm hover:bg-red-700">
          <i class="ti ti-trash"></i> Ta bort fråga
        </button>
      </form>
    </div>
  </aside>
</section>

<!-- Snackbar för små notifieringar -->
<div id="snack"
     class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden rounded-lg border px-4 py-2 text-sm shadow"></div>

<script>
(function(){
  var root  = document.getElementById('qView');
  var qid   = Number(root && root.dataset.qid);
  var snack = document.getElementById('snack');

  function toast(text, ok) {
    snack.textContent = text;
    snack.className =
      'fixed bottom-4 left-1/2 -translate-x-1/2 rounded-lg px-4 py-2 text-sm shadow ' +
      (ok !== false
        ? 'bg-emerald-50 text-emerald-800 border border-emerald-200'
        : 'bg-red-50 text-red-800 border border-red-200');
    snack.classList.remove('hidden');
    setTimeout(function(){ snack.classList.add('hidden'); }, 2000);
  }

  // Byt status
  document.querySelectorAll('[data-status]').forEach(function(btn){
    btn.addEventListener('click', function(){
      var status = btn.getAttribute('data-status');
      fetch('/api/questions/' + qid + '/status', {
        method: 'PUT',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ status: status })
      })
      .then(function(res){ return res.json().then(function(d){ return { ok: res.ok, data: d }; }); })
      .then(function(resp){
        if (!resp.ok) throw new Error(resp.data && resp.data.error || 'Fel');
        toast('Status uppdaterad');
        location.reload();
      })
      .catch(function(){ toast('Kunde inte uppdatera status', false); });
    });
  });

  // Autosuggest + koppla ämne
  var input = document.getElementById('topicSearch');
  var box   = document.getElementById('suggestBox');
  var timer = null;

  function escapeHtml(s){
    return (s || '').replace(/[&<>"']/g, function(m){
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]);
    });
  }

  function renderSuggest(rows){
    if (!rows || !rows.length){
      box.classList.add('hidden');
      box.innerHTML = '';
      return;
    }
    var html = rows.map(function(r){
      var t  = escapeHtml(r.title || '');
      var sn = r.snippet ? '<div class="text-sm text-slate-600">' + escapeHtml(r.snippet) + '</div>' : '';
      return (
        '<button type="button" data-id="' + r.id + '" class="w-full text-left px-4 py-3 hover:bg-slate-50">' +
          '<div class="font-medium text-slate-900">' + t + '</div>' +
          sn +
        '</button>'
      );
    }).join('');
    box.innerHTML = html;
    box.classList.remove('hidden');
  }

  function fetchSuggest(q){
    if (!q) { renderSuggest([]); return; }
    fetch('/api/suggest?q=' + encodeURIComponent(q))
      .then(function(res){ return res.json(); })
      .then(function(rows){ renderSuggest(Array.isArray(rows) ? rows : []); })
      .catch(function(){ /* ignore */ });
  }

  if (input){
    input.addEventListener('input', function(){
      clearTimeout(timer);
      var q = input.value.trim();
      timer = setTimeout(function(){ fetchSuggest(q); }, 150);
    });
    document.addEventListener('click', function(e){
      if (!e.target.closest('#suggestBox') && e.target !== input) box.classList.add('hidden');
    });
  }

  if (box){
    box.addEventListener('click', function(e){
      var btn = e.target.closest('button[data-id]');
      if (!btn) return;
      var topicId = btn.getAttribute('data-id');
fetch('/api/questions/' + qid + '/attach-topic', {
  method: 'PUT',
  headers: { 'Content-Type':'application/json' },
  body: JSON.stringify({ topicId: topicId, replace: true })
})
      .then(function(res){ return res.json().then(function(d){ return { ok: res.ok, data: d }; }); })
      .then(function(resp){
        if (!resp.ok) throw new Error(resp.data && resp.data.error || 'Fel');
        toast('Ämne kopplat');
        location.reload();
      })
      .catch(function(){ toast('Kunde inte koppla ämne', false); });
    });
  }

  // Confirm delete
  var delForm = document.querySelector('[data-del-form]');
  if (delForm){
    delForm.addEventListener('submit', function(e){
      var t = delForm.dataset.title || '';
      if (!confirm('Ta bort frågan "' + t + '"? Detta går inte att ångra.')) e.preventDefault();
    });
  }

  // Spara EN kategori
  var saveBtn   = document.getElementById('btnSaveCat');
  var selectEl  = document.getElementById('catSelect');
  var qroot     = document.getElementById('qView');
  var qid       = Number(qroot && qroot.dataset.qid);

  function toast(text, ok){
    var snack = document.getElementById('snack');
    snack.textContent = text;
    snack.className =
      'fixed bottom-4 left-1/2 -translate-x-1/2 rounded-lg px-4 py-2 text-sm shadow ' +
      (ok !== false
        ? 'bg-emerald-50 text-emerald-800 border border-emerald-200'
        : 'bg-red-50 text-red-800 border border-red-200');
    snack.classList.remove('hidden');
    setTimeout(function(){ snack.classList.add('hidden'); }, 2000);
  }

  if (saveBtn && selectEl) {
    saveBtn.addEventListener('click', function(){
      var val = selectEl.value ? [ String(selectEl.value) ] : []; // skicka en array med 1 id (eller tomt)
      fetch('/api/questions/' + qid + '/categories', {
        method: 'PUT',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ category_ids: val })
      })
      .then(function(res){ return res.json().then(function(d){ return { ok: res.ok, data: d }; }); })
      .then(function(resp){
        if (!resp.ok) throw new Error(resp.data && resp.data.error || 'Fel');
        toast('Kategori sparad');
        // valfritt: location.reload();
      })
      .catch(function(){ toast('Kunde inte spara kategori', false); });
    });
  }


})();
</script>
<script src="/tinymce/tinymce.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  tinymce.init({
    selector: '#answerEditor',
    height: 400,
    menubar: false,
    branding: false,
    promotion: false,
    base_url: '/tinymce',
    plugins: 'link image media table lists code',
    toolbar: 'undo redo | blocks | bold italic underline | ' +
             'bullist numlist | alignleft aligncenter alignright | ' +
             'link image media table | code',
    block_formats: 'Rubrik 1=h1; Rubrik 2=h2; Rubrik 3=h3; Brödtext=p',
    media_live_embeds: true,
    extended_valid_elements: 'iframe[src|frameborder|allowfullscreen|width|height|name|title|allow|referrerpolicy|sandbox]',
    paste_data_images: true,
    automatic_uploads: false,
    images_upload_handler: function (_blobInfo, _success, fail) {
      fail('Uppladdning är avstängd här. Använd bild-URL eller klistra in.');
    },
    convert_urls: false,
    content_style: 'body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;font-size:16px;line-height:1.65}'
  });
});
</script>