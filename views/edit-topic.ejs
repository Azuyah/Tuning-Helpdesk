<section class="mx-auto max-w-3xl px-4 py-10">
  <h1 class="text-2xl font-bold text-slate-900 mb-6">Redigera ämne</h1>

  <%
const curCat = String(currentCat || '');
const moveAction = curCat
  ? `/admin/categories/${encodeURIComponent(curCat)}/topics/${encodeURIComponent(topic.id)}/move`
  : '';
%>

  <form method="POST" action="/admin/edit-topic/<%= topic.id %>" class="space-y-5">
    <div class="text-xs text-slate-500">
      ID (slug): <code class="bg-slate-100 px-1 py-0.5 rounded"><%= topic.id %></code>
    </div>

    <div>
      <label class="block text-sm font-medium text-slate-700">Titel</label>
      <input type="text" name="title" value="<%- topic.title %>" required
             class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 shadow-sm 
                    focus:border-sky-500 focus:ring-sky-500 sm:text-sm">
    </div>

    <div>
      <label class="block text-sm font-medium text-slate-700">Kort beskrivning</label>
      <textarea name="excerpt" rows="2"
                class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 shadow-sm 
                       focus:border-sky-500 focus:ring-sky-500 sm:text-sm"><%- topic.excerpt %></textarea>
    </div>

    <div>
      <label class="block text-sm font-medium text-slate-700">Innehåll</label>
      <!-- textarea target för editorn -->
      <textarea id="bodyEditor" name="body" rows="10"><%- topic.body %></textarea>
    </div>

    <!-- Taggar -->
    <div>
      <label class="block text-sm font-medium text-slate-700 mb-1">Taggar</label>
      <input type="text" name="tags" value="<%- topic.tags || '' %>"
             placeholder="ex: autotuner, virtual read, credits"
             class="w-full rounded-lg border border-slate-300 px-3 py-2 shadow-sm
                    focus:border-sky-500 focus:ring-sky-500 sm:text-sm">
      <p class="text-xs text-slate-500 mt-1">Används för sök och filter (komma-separerade).</p>
    </div>

  <!-- Kategori -->
<div>
  <label class="block text-sm font-medium text-slate-700 mb-1">Kategori</label>
  <div class="relative">
<select id="categorySelect" name="categoryId"
        data-current="<%= curCat %>"
        class="w-full rounded-lg border border-slate-300 px-3 py-2 shadow-sm
               focus:border-sky-500 focus:ring-sky-500 sm:text-sm bg-white appearance-none">
      <option value="">— Välj kategori —</option>
      <% (categories || []).forEach(c => { %>
        <option value="<%= c.id %>" <%= String(curCat)===String(c.id) ? 'selected' : '' %>>
          <%= c.title %>
        </option>
      <% }) %>
    </select>
    <i class="ti ti-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none"></i>
  </div>
  <p class="text-xs text-slate-500 mt-1">Primär kategori för ämnet.</p>
</div>

    <!-- Resurs-inställningar -->
<div class="grid sm:grid-cols-2 gap-4">
  <label class="inline-flex items-center gap-2">
    <input type="checkbox" name="is_resource" value="1" <%= Number(topic?.is_resource) === 1 ? 'checked' : '' %> />
    Detta är en resurs
  </label>

  <%
    const dl = (topic?.download_url || '').trim();
    const isInternal = dl.startsWith('/public/resources/');
    const hasAny = Array.isArray(downloadFiles) && downloadFiles.length > 0;
  %>

<div>
  <label class="block text-sm font-medium text-slate-700 mb-1">Resursfil</label>

  <div class="relative">
    <select id="downloadSelect"
            class="w-full rounded-lg border border-slate-300 px-3 py-2 shadow-sm
                   focus:border-sky-500 focus:ring-sky-500 sm:text-sm bg-white appearance-none
                   <%= hasAny ? '' : 'bg-slate-50 text-slate-400 cursor-not-allowed' %>"
            <%= hasAny ? '' : 'disabled' %>>
      <option value="">— Välj fil från servern —</option>
      <% if (hasAny) { downloadFiles.forEach(f => { %>
        <option value="<%- f.url %>" <%= (isInternal && dl === f.url) ? 'selected' : '' %>><%- f.relPath %></option>
      <% }); } %>
      <option value="__custom__" <%= (!isInternal && dl) ? 'selected' : '' %>>Annan URL …</option>
    </select>
    <i class="ti ti-chevron-down absolute right-3 top-1/2 -translate-y-1/2
               text-slate-500 pointer-events-none"></i>
  </div>

  <!-- Fältet som POST:as till servern -->
<input id="downloadUrlInput"
       type="text"
       name="download_url"
       value="<%- dl %>"
       placeholder="https://… eller /public/resources/fil.zip"
       class="mt-2 w-full rounded-lg border border-slate-300 px-3 py-2 shadow-sm
              focus:border-sky-500 focus:ring-sky-500 sm:text-sm <%= (!isInternal && dl) ? '' : 'hidden' %>"/>
  <p class="text-xs text-slate-500 mt-1">Välj fil från servern eller “Annan URL …” för att skriva egen länk.</p>
</div>
    <!-- Spara-knapp -->
    <div class="pt-4">
      <button type="submit"
              class="w-full sm:w-auto inline-flex items-center justify-center gap-2 rounded-lg bg-sky-600 px-6 py-3 text-white font-semibold shadow hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-1">
        <i class="ti ti-device-floppy text-lg"></i>
        Spara ändringar
      </button>
    </div>
  </form>
</section>

<!-- Self-hosted TinyMCE -->
<script src="/tinymce/tinymce.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  tinymce.init({
    selector: '#bodyEditor',
    height: 500,
    menubar: false,
    branding: false,
    promotion: false,
    base_url: '/tinymce',                          // så Tiny hittar sina assets
    plugins: 'link image media table lists code',  // listor + media/YouTube
    toolbar: 'undo redo | blocks | bold italic underline | ' +
             'bullist numlist | alignleft aligncenter alignright | ' +
             'link image media table | code',
    block_formats: 'Rubrik 1=h1; Rubrik 2=h2; Rubrik 3=h3; Brödtext=p',
    media_live_embeds: true,
    // tillåt <iframe> för YouTube m.m.
    extended_valid_elements: 'iframe[src|frameborder|allowfullscreen|width|height|name|title|allow|referrerpolicy|sandbox]',
    // ingen upload i denna vy: använd URL eller klistra in
    paste_data_images: true,
    automatic_uploads: false,
    images_upload_handler: function (_blobInfo, _success, fail) {
      fail('Uppladdning är avstängd här. Använd bild-URL eller klistra in.');
    },
    convert_urls: false,
    content_style: 'body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;font-size:16px;line-height:1.65}'
  });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const sel = document.getElementById('categorySelect');
  if (!sel) return;

  sel.addEventListener('change', () => {
    const newCat = sel.value;
    const curCat = sel.dataset.current || '';
    const moveAction = sel.dataset.moveAction || '';

    if (newCat && moveAction) {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = moveAction;

      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'newCategoryId';
      input.value = newCat;

      form.appendChild(input);
      document.body.appendChild(form);
      form.submit();
    }
  });
});
</script>

<script>
(function(){
  const sel = document.getElementById('downloadSelect');
  const inp = document.getElementById('downloadUrlInput');
  if (!sel || !inp) return;

  function sync() {
    const v = sel.value;
    if (v === '__custom__') {
      // Visa fritextfältet för egen URL
      inp.classList.remove('hidden');
      // Rensa inte automatiskt – låt användaren skriva/klistra in
      inp.focus();
    } else if (v) {
      // Vald serverfil → skriv in sökvägen och dölj input (men låt den vara enabled!)
      inp.value = v;
      inp.classList.add('hidden');
    } else {
      // “— Välj fil —” → nollställ och dölj
      inp.value = '';
      inp.classList.add('hidden');
    }
  }

  // Kör vid start och vid ändring
  sync();
  sel.addEventListener('change', sync);
})();
</script>