<section class="mx-auto max-w-3xl px-4 py-10">
  <h1 class="text-2xl font-bold text-slate-900 mb-6">Redigera ämne</h1>

  <form id="editForm" method="POST" action="/admin/edit-topic/<%= topic.id %>" class="space-y-5">
    <div class="text-xs text-slate-500">
      ID (slug): <code class="bg-slate-100 px-1 py-0.5 rounded"><%= topic.id %></code>
    </div>

    <!-- Titel -->
    <div>
      <label class="block text-sm font-medium text-slate-700">Titel</label>
      <input type="text" name="title" value="<%- topic.title %>" required
             class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 shadow-sm 
                    focus:border-sky-500 focus:ring-sky-500 sm:text-sm">
    </div>

    <!-- Kort beskrivning -->
    <div>
      <label class="block text-sm font-medium text-slate-700">Kort beskrivning</label>
      <textarea name="excerpt" rows="2"
                class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 shadow-sm 
                       focus:border-sky-500 focus:ring-sky-500 sm:text-sm"><%- topic.excerpt %></textarea>
    </div>

    <!-- Innehåll med Quill -->
    <div>
      <label class="block text-sm font-medium text-slate-700">Innehåll</label>

      <!-- Quill CSS -->
      <link rel="stylesheet" href="https://cdn.quilljs.com/1.3.7/quill.snow.css">

      <!-- Wrapper som håller vår egen ram/rundning, Quill utan egna borders -->
      <div class="quill-wrapper mt-1">
        <div id="editor"></div>
      </div>

      <!-- Dolt fält som skickas till servern -->
      <input type="hidden" name="body" id="contentHtml">

      <!-- Dold textarea med ursprungligt innehåll (för förifyllning) -->
      <textarea id="initialContent" hidden><%- topic.body || '' %></textarea>
    </div>

    <!-- Taggar -->
    <div>
      <label class="block text-sm font-medium text-slate-700 mb-1">Taggar</label>
      <input type="text" name="tags" value="<%- topic.tags || '' %>"
             placeholder="ex: autotuner, virtual read, credits"
             class="w-full rounded-lg border border-slate-300 px-3 py-2 shadow-sm
                    focus:border-sky-500 focus:ring-sky-500 sm:text-sm">
      <p class="text-xs text-slate-500 mt-1">Används för sök och filter (komma-separerade).</p>
    </div>

    <!-- Kategori -->
    <div>
      <label class="block text-sm font-medium text-slate-700 mb-1">Kategori</label>
      <div class="relative">
        <select name="categoryId"
                class="w-full rounded-lg border border-slate-300 px-3 py-2 shadow-sm
                       focus:border-sky-500 focus:ring-sky-500 sm:text-sm bg-white appearance-none">
          <option value="">— Välj kategori —</option>
          <% (categories || []).forEach(c => { %>
            <option value="<%= c.id %>" <%= currentCat === c.id ? 'selected' : '' %>>
              <%= c.title %>
            </option>
          <% }) %>
        </select>
        <i class="ti ti-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none"></i>
      </div>
      <p class="text-xs text-slate-500 mt-1">Primär kategori för ämnet.</p>
    </div>

    <!-- Resurs-inställningar -->
    <div class="mt-6 grid sm:grid-cols-2 gap-4">
      <label class="inline-flex items-center gap-2">
        <input type="checkbox" name="is_resource" value="1"
               <%= Number(topic.is_resource) === 1 ? 'checked' : '' %> />
        Detta är en resurs
      </label>

      <input type="url" name="download_url"
             value="<%- topic.download_url || '' %>"
             placeholder="https://… eller /public/files/fil.zip"
             class="w-full rounded-lg border border-slate-300 px-3 py-2 shadow-sm
                    focus:border-sky-500 focus:ring-sky-500 sm:text-sm" />
    </div>

    <!-- Knapp -->
    <div class="flex gap-3">
      <button type="submit"
              class="rounded-lg bg-sky-600 text-white px-5 py-2 font-medium hover:bg-sky-700 shadow-sm">
        Spara
      </button>
      <a href="/admin"
         class="rounded-lg border border-slate-300 px-5 py-2 font-medium text-slate-700 hover:bg-slate-50">
        Avbryt
      </a>
    </div>
  </form>
</section>

<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<script>
  (function () {
    const toolbar = [
      [{ header: [1, 2, 3, false] }],
      ['bold', 'italic', 'underline'],
      [{ list: 'ordered' }, { list: 'bullet' }],
      ['blockquote', 'link'],
      ['clean']
    ];

    const quill = new Quill('#editor', {
      theme: 'snow',
      modules: { toolbar }
    });

    // Placeholder (visas via CSS på tom editor)
    quill.root.setAttribute('data-placeholder', 'Skriv eller klistra in ditt innehåll här...');

    // Förifyll från dold textarea
    const initial = document.getElementById('initialContent').value;
    if (initial && initial.trim().length) {
      quill.root.innerHTML = initial;
    } else {
      quill.root.innerHTML = '<p><br></p>'; // säker tomstart
    }

    // På submit: flytta Quill-HTML till hidden input
    document.getElementById('editForm').addEventListener('submit', function () {
      document.getElementById('contentHtml').value = quill.root.innerHTML;
    });
  })();
</script>

<style>
/* Snygg wrapper runt Quill (vår ram), utan Quills egna borders */
.quill-wrapper {
  border: 1px solid #cbd5e1;             /* slate-300 */
  border-radius: 0.5rem;                  /* rounded-lg */
  background: #fff;
}

/* Ta bort Quills egna kanter så vi slipper dubbelram */
.quill-wrapper .ql-container,
.quill-wrapper .ql-toolbar {
  border: 0 !important;
}

/* Diskret linje mellan toolbar och editor + rundade hörn upptill */
.quill-wrapper .ql-toolbar {
  border-bottom: 1px solid #e2e8f0 !important; /* slate-200 */
  border-radius: 0.5rem 0.5rem 0 0;
}

/* Min-höjd och typografi i editorn */
.quill-wrapper .ql-editor {
  min-height: 220px;
  font-size: 0.875rem; /* sm */
  line-height: 1.5;
}

/* Fin fokus-stil istället för ful standardram */
.quill-wrapper:focus-within {
  outline: none;
  box-shadow: 0 0 0 2px rgba(14,165,233,.35);  /* sky-500 ring */
  border-color: #0ea5e9;                       /* sky-500 */
}

/* Placeholder-trick (visas när editorn är tom) */
.quill-wrapper .ql-editor:empty::before {
  content: attr(data-placeholder);
  color: #94a3b8; /* slate-400 */
}
</style>