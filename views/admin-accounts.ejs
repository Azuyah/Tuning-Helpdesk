<!-- views/admin-accounts.ejs -->
<section class="mx-auto max-w-6xl px-4 py-10 space-y-10">

  <!-- Topp: titel + totals -->
  <div class="flex flex-col gap-1 sm:flex-row sm:items-end sm:justify-between">
    <div>
      <h1 class="text-2xl font-bold text-slate-900">Alla konton & dealers</h1>
      <div class="mt-1 text-slate-600 text-sm">
        Totalt dealers: <span class="font-medium"><%= totalDealersAll %></span>
        • Matchar filter: <span class="font-medium"><%= totalFiltered %></span>
      </div>
    </div>
  </div>

  <!-- Users -->
  <div class="space-y-4">
    <div class="flex items-center justify-between">
      <h2 class="text-xl font-semibold text-slate-900">Användare (users)</h2>
      <%
        const uPage       = Number(typeof usersPage === 'undefined' ? 1 : usersPage);
        const uTotalPages = Number(typeof usersTotalPages === 'undefined' ? 1 : usersTotalPages);
        const uTotal      = Number(typeof usersTotal === 'undefined' ? (users ? users.length : 0) : usersTotal);
      %>
      <div class="text-sm text-slate-600">Visar sida <%= uPage %> av <%= uTotalPages %></div>
    </div>

    <% if (!users || users.length === 0) { %>
      <div class="rounded-xl border border-slate-200 bg-white p-6 text-slate-600">Inga användare hittades.</div>
    <% } else { %>
      <div class="overflow-x-auto rounded-xl border border-slate-200 bg-white shadow-sm">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 text-slate-700 text-left font-semibold">
            <tr>
              <th class="px-4 py-2">ID</th>
              <th class="px-4 py-2">Email</th>
              <th class="px-4 py-2">Namn</th>
              <th class="px-4 py-2">Roll</th>
              <th class="px-4 py-2">Åtgärd</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200">
            <% users.forEach(u => { %>
              <tr class="hover:bg-slate-50">
                <td class="px-4 py-2 font-mono text-xs text-slate-500"><%= u.id %></td>
                <td class="px-4 py-2"><%= u.email %></td>
                <td class="px-4 py-2"><%= u.name || '-' %></td>

                <!-- Roll -->
                <td class="px-4 py-2">
                  <span class="inline-flex items-center px-2 py-0.5 rounded text-xs
                    <%= u.role === 'admin' ? 'bg-red-100 text-red-700' :
                        u.role === 'support' ? 'bg-violet-100 text-violet-700' :
                        u.role === 'dealer' ? 'bg-amber-100 text-amber-700' :
                        'bg-emerald-100 text-emerald-700' %>">
                    <%= u.role %>
                  </span>
                </td>

                <!-- Åtgärd -->
                <td class="px-4 py-2">
                  <div class="relative inline-block">
                    <button type="button"
                            class="text-xs px-2 py-1 rounded border border-slate-300 hover:bg-slate-50 btn-role"
                            data-user-id="<%= u.id %>">
                      Ändra roll
                    </button>

                    <div class="role-menu absolute z-10 mt-2 w-40 bg-white border border-slate-200 rounded-lg shadow-lg hidden">
                      <% ['user','support','dealer','admin'].forEach(function(r){ %>
                        <button type="button"
                                class="w-full text-left px-3 py-2 hover:bg-slate-50 text-sm role-option"
                                data-user-id="<%= u.id %>"
                                data-role="<%= r %>">
                          <%= r %>
                        </button>
                      <% }) %>
                    </div>
                  </div>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <!-- Users pagination -->
      <div class="flex items-center justify-between">
        <div class="text-sm text-slate-600">
          Visar <%= users.length %> av <%= uTotal %> användare
        </div>
        <div class="inline-flex gap-1">
          <%
            function usersLink(p){
              const params = new URLSearchParams({
                tab: 'users',
                usersPage: p
              });
              return `/admin-accounts?${params.toString()}`;
            }
          %>
          <a href="<%= uPage>1 ? usersLink(uPage-1) : '#' %>"
             class="px-3 py-1.5 rounded-lg border text-sm <%= uPage>1 ? 'hover:bg-slate-50 border-slate-300' : 'border-slate-200 text-slate-400 pointer-events-none' %>">Föregående</a>
          <% for (let i=Math.max(1, uPage-2); i<=Math.min(uTotalPages, uPage+2); i++){ %>
            <a href="<%= usersLink(i) %>"
               class="px-3 py-1.5 rounded-lg border text-sm <%= i===uPage ? 'bg-sky-600 text-white border-sky-600' : 'border-slate-300 hover:bg-slate-50' %>"><%= i %></a>
          <% } %>
          <a href="<%= uPage<uTotalPages ? usersLink(uPage+1) : '#' %>"
             class="px-3 py-1.5 rounded-lg border text-sm <%= uPage<uTotalPages ? 'hover:bg-slate-50 border-slate-300' : 'border-slate-200 text-slate-400 pointer-events-none' %>">Nästa</a>
        </div>
      </div>
    <% } %>
  </div>

  <!-- Filters for DEALERS -->
  <form method="get" action="/admin-accounts" class="mt-8">
    <div class="grid md:grid-cols-3 lg:grid-cols-4 gap-6 items-end">
      <input type="hidden" name="tab" value="dealers">

      <!-- Sök -->
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Sök (email, namn, företag, användarnamn)</label>
        <input type="search" name="q" value="<%= (q || '') %>" placeholder="t.ex. johanna, dynex, @gmail.com"
               class="w-full rounded-lg border border-slate-300 px-3 py-2 shadow-sm focus:border-sky-500 focus:ring-sky-500 sm:text-sm"/>
      </div>

      <!-- Källa -->
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Källa</label>
        <div class="relative">
          <select name="source"
                  class="w-full rounded-lg border border-slate-300 px-3 py-2 shadow-sm
                         focus:border-sky-500 focus:ring-sky-500 sm:text-sm bg-white appearance-none">
            <option value=""     <%= !source ? 'selected' : '' %> >Alla</option>
            <option value="nms"  <%= source==='nms'   ? 'selected' : '' %> >NMS</option>
            <option value="dynex"<%= source==='dynex' ? 'selected' : '' %> >DYNEX</option>
          </select>
          <i class="ti ti-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none"></i>
        </div>
      </div>

      <!-- Resultat per sida (för dealers) -->
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Resultat per sida</label>
        <div class="relative">
          <select name="perPage"
                  class="w-full rounded-lg border border-slate-300 px-3 py-2 shadow-sm
                         focus:border-sky-500 focus:ring-sky-500 sm:text-sm bg-white appearance-none">
            <% const pp = Number(typeof perPage === 'undefined' ? 10 : perPage); %>
            <option value="10"  <%= pp===10  ? 'selected' : '' %>>10</option>
            <option value="30"  <%= pp===30  ? 'selected' : '' %>>30</option>
            <option value="50"  <%= pp===50  ? 'selected' : '' %>>50</option>
            <option value="100" <%= pp===100 ? 'selected' : '' %>>100</option>
          </select>
          <i class="ti ti-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none"></i>
        </div>
      </div>

      <!-- Submit -->
      <div class="md:col-span-3 lg:col-span-1">
        <button type="submit"
                class="inline-flex items-center gap-2 rounded-xl bg-sky-600 text-white px-5 py-2.5 font-medium shadow hover:bg-sky-700 transition">
          <i class="ti ti-filter"></i> Filtrera
        </button>
      </div>
    </div>
  </form>

  <!-- Dealers -->
  <div class="space-y-4">
    <div class="flex items-center justify-between">
      <h2 class="text-xl font-semibold text-slate-900">Dealers (NMS & Dynex)</h2>
      <div class="text-sm text-slate-600">Visar sida <%= page %> av <%= totalPages %></div>
    </div>

    <% if (!dealers || dealers.length === 0) { %>
      <div class="rounded-xl border border-slate-200 bg-white p-6 text-slate-600">Inga dealers hittades.</div>
    <% } else { %>
      <div class="overflow-x-auto rounded-xl border border-slate-200 bg-white shadow-sm">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 text-slate-700 text-left font-semibold">
            <tr>
              <th class="px-4 py-2">Källa</th>
              <th class="px-4 py-2">Email</th>
              <th class="px-4 py-2">Namn</th>
              <th class="px-4 py-2">Företag</th>
              <th class="px-4 py-2">Telefon</th>
              <th class="px-4 py-2">Åtgärd</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200">
            <% dealers.forEach(d => { %>
              <tr class="hover:bg-slate-50">
                <td class="px-4 py-2"><%= (d.source || '').toUpperCase() %></td>
                <td class="px-4 py-2"><%= d.email || '-' %></td>
                <td class="px-4 py-2"><%= [d.firstname, d.lastname].filter(Boolean).join(' ') || d.username || '-' %></td>
                <td class="px-4 py-2"><%= d.company || '-' %></td>
                <td class="px-4 py-2"><%= d.telephone || '-' %></td>

                <!-- Åtgärd -->
                <td class="px-4 py-2">
                  <div class="relative inline-block">
                    <button type="button"
                            class="text-xs px-2 py-1 rounded border border-slate-300 hover:bg-slate-50 btn-role-dealer"
                            data-email="<%= d.email || '' %>">
                      Ändra roll
                    </button>

                    <div class="role-menu absolute z-10 mt-2 w-40 bg-white border border-slate-200 rounded-lg shadow-lg hidden">
                      <% ['user','support','dealer','admin'].forEach(function(r){ %>
                        <button type="button"
                                class="w-full text-left px-3 py-2 hover:bg-slate-50 text-sm role-option-dealer"
                                data-email="<%= d.email || '' %>"
                                data-role="<%= r %>">
                          <%= r %>
                        </button>
                      <% }) %>
                    </div>
                  </div>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <!-- Pagination (dealers) -->
      <div class="flex items-center justify-between">
        <div class="text-sm text-slate-600">
          Visar <%= dealers.length %> av <%= totalFiltered %> matchningar
        </div>
        <div class="inline-flex gap-1">
          <%
            function link(p){
              const params = new URLSearchParams({
                q: (typeof q==='undefined' ? '' : q),
                source: (typeof source==='undefined' ? '' : source),
                perPage: (typeof perPage==='undefined' ? 10 : perPage),
                page: p,
                tab: 'dealers'
              });
              return `/admin-accounts?${params.toString()}`;
            }
          %>
          <a href="<%= page>1 ? link(page-1) : '#' %>"
             class="px-3 py-1.5 rounded-lg border text-sm <%= page>1 ? 'hover:bg-slate-50 border-slate-300' : 'border-slate-200 text-slate-400 pointer-events-none' %>">Föregående</a>
          <% for (let i=Math.max(1, page-2); i<=Math.min(totalPages, page+2); i++){ %>
            <a href="<%= link(i) %>"
               class="px-3 py-1.5 rounded-lg border text-sm <%= i===page ? 'bg-sky-600 text-white border-sky-600' : 'border-slate-300 hover:bg-slate-50' %>"><%= i %></a>
          <% } %>
          <a href="<%= page<totalPages ? link(page+1) : '#' %>"
             class="px-3 py-1.5 rounded-lg border text-sm <%= page<totalPages ? 'hover:bg-slate-50 border-slate-300' : 'border-slate-200 text-slate-400 pointer-events-none' %>">Nästa</a>
        </div>
      </div>
    <% } %>
  </div>
</section>

<!-- Dropdown-hantering: USERS -->
<script>
(function(){
  // Öppna/stäng users dropdown
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.btn-role');
    const opt = e.target.closest('.role-option');

    // Klick på “Ändra roll”-knapp
    if (btn) {
      e.stopPropagation();
      document.querySelectorAll('.role-menu').forEach(m => m.classList.add('hidden'));
      const menu = btn.parentElement.querySelector('.role-menu');
      if (menu) menu.classList.toggle('hidden');
      return;
    }

    // Välj roll
    if (opt) {
      e.stopPropagation();
      const userId = opt.getAttribute('data-user-id');
      const role   = opt.getAttribute('data-role');

      fetch('/api/users/' + userId + '/role', {
        method: 'PUT',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ role })
      })
      .then(res => res.json().then(d => ({ ok: res.ok, data: d })))
      .then(resp => {
        if (!resp.ok) throw new Error(resp.data && resp.data.error || 'Kunde inte uppdatera roll');
        location.reload();
      })
      .catch(err => alert(err.message || 'Fel vid uppdatering'));
      return;
    }

    // Klick utanför stänger alla
    document.querySelectorAll('.role-menu').forEach(m => m.classList.add('hidden'));
  });
})();
</script>

<!-- Dropdown-hantering: DEALERS (uppdatera roll via email) -->
<script>
(function(){
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.btn-role-dealer');
    const opt = e.target.closest('.role-option-dealer');

    // Knapp
    if (btn) {
      e.stopPropagation();
      document.querySelectorAll('.role-menu').forEach(m => m.classList.add('hidden'));
      const menu = btn.parentElement.querySelector('.role-menu');
      if (menu) menu.classList.toggle('hidden');
      return;
    }

    // Välj roll
    if (opt) {
      e.stopPropagation();
      const email = opt.getAttribute('data-email');
      const role  = opt.getAttribute('data-role');

      fetch('/api/dealers/' + dealerId + '/role', {
        method: 'PUT',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ email, role })
      })
      .then(res => res.json().then(d => ({ ok: res.ok, data: d })))
      .then(resp => {
        if (!resp.ok) throw new Error(resp.data && resp.data.error || 'Kunde inte uppdatera roll');
        location.reload();
      })
      .catch(err => alert(err.message || 'Fel vid uppdatering'));
      return;
    }

    // Klick utanför
    document.querySelectorAll('.role-menu').forEach(m => m.classList.add('hidden'));
  });
})();
</script>