<!-- views/partials/header.ejs -->
<header class="sticky top-0 z-40 border-b bg-white/75 dark:bg-slate-950/90 backdrop-blur transition-colors">
  <div class="mx-auto max-w-6xl px-4 relative">
    <div class="h-16 flex items-center gap-4">

      <!-- Brand -->
<a href="/" class="inline-flex items-center gap-2">
  <img src="/public/TuningHelpdesk.png"
       alt="Tuning Helpdesk"
       class="h-8 w-auto object-contain" />
</a>

      <!-- Desktop nav -->
      <nav class="ml-4 hidden md:flex items-center gap-1 text-sm">
        <a href="/" 
           class="px-3 py-2 rounded-lg text-slate-700 hover:bg-slate-100 
                  dark:text-slate-200 dark:hover:bg-white/5 
                  relative after:pointer-events-none after:absolute after:inset-x-3 
                  after:-bottom-0.5 after:h-0.5 after:rounded after:bg-sky-600 
                  dark:after:bg-red-500/80 after:scale-x-0 hover:after:scale-x-100 
                  after:transition">Hem</a>

        <a href="/ask" 
           class="px-3 py-2 rounded-lg text-slate-700 hover:bg-slate-100 
                  dark:text-slate-200 dark:hover:bg-white/5 
                  relative after:pointer-events-none after:absolute after:inset-x-3 
                  after:-bottom-0.5 after:h-0.5 after:rounded after:bg-sky-600 
                  dark:after:bg-red-500/80 after:scale-x-0 hover:after:scale-x-100 
                  after:transition">Ställ fråga</a>

        <a href="/resources" 
           class="px-3 py-2 rounded-lg text-slate-700 hover:bg-slate-100 
                  dark:text-slate-200 dark:hover:bg-white/5 
                  relative after:pointer-events-none after:absolute after:inset-x-3 
                  after:-bottom-0.5 after:h-0.5 after:rounded after:bg-sky-600 
                  dark:after:bg-red-500/80 after:scale-x-0 hover:after:scale-x-100 
                  after:transition">Resurser</a>

        <a href="/explore" 
           class="px-3 py-2 rounded-lg text-slate-700 hover:bg-slate-100 
                  dark:text-slate-200 dark:hover:bg-white/5 
                  relative after:pointer-events-none after:absolute after:inset-x-3 
                  after:-bottom-0.5 after:h-0.5 after:rounded after:bg-sky-600 
                  dark:after:bg-red-500/80 after:scale-x-0 hover:after:scale-x-100 
                  after:transition">Utforska</a>


                          <a href="/dtc" 
           class="px-3 py-2 rounded-lg text-slate-700 hover:bg-slate-100 
                  dark:text-slate-200 dark:hover:bg-white/5 
                  relative after:pointer-events-none after:absolute after:inset-x-3 
                  after:-bottom-0.5 after:h-0.5 after:rounded after:bg-sky-600 
                  dark:after:bg-red-500/80 after:scale-x-0 hover:after:scale-x-100 
                  after:transition">DTC databas</a>

                  <a href="/feedback" 
   class="px-3 py-2 rounded-lg text-slate-700 hover:bg-slate-100 
          dark:text-slate-200 dark:hover:bg-white/5 
          relative after:pointer-events-none after:absolute after:inset-x-3 
          after:-bottom-0.5 after:h-0.5 after:rounded after:bg-sky-600 
          dark:after:bg-red-500/80 after:scale-x-0 hover:after:scale-x-100 
          after:transition">
  Feedback
</a>

<% if (me && (me.role === 'admin' || me.role === 'support')) { %>
  <a href="/support-questions"
     class="px-3 py-2 rounded-lg text-slate-700 hover:bg-slate-100 dark:text-slate-200 dark:hover:bg-white/5 relative after:pointer-events-none after:absolute after:inset-x-3 after:-bottom-0.5 after:h-0.5 after:rounded after:bg-amber-500 after:scale-x-0 hover:after:scale-x-100 after:transition">
    Support
    <span class="ml-2 text-[10px] px-1.5 py-0.5 rounded bg-amber-100 text-amber-700 border border-amber-200 dark:bg-amber-200/10 dark:text-amber-300 dark:border-amber-400/30">beta</span>
  </a>
<% } %>
      </nav>

      <!-- Spacer -->
      <div class="flex-1"></div>

<!-- Notification/Bell (syns endast om inloggad) -->
<% if (me) { %>
  <div class="relative" id="notifWrapper">
    <button id="notifBtn"
            class="relative inline-flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-100 focus:outline-none">
      <i class="ti ti-bell text-xl"></i>

      <% if (Number(notifCount || 0) > 0) { %>
        <span class="absolute -top-1 -right-1 min-w-[1.25rem] h-5 px-1 rounded-full bg-red-600 text-white text-xs flex items-center justify-center">
          <%= notifCount %>
        </span>
      <% } %>
    </button>

    <!-- Popup -->
<div id="notifPopup"
     class="hidden absolute top-12 right-0 z-50
            w-72 sm:w-80
            max-w-[calc(100vw-1rem)]
            max-h-[70vh] overflow-auto overscroll-contain
            bg-white rounded-xl shadow-lg border border-slate-200">
      <div class="p-4 border-b border-slate-100 font-semibold text-slate-700">
        Notiser
      </div>
      <ul class="max-h-64 overflow-y-auto divide-y divide-slate-100" id="notifList">
        <% if (Array.isArray(notifications) && notifications.length) { %>
          <% notifications.forEach(n => { %>
            <li class="p-3 hover:bg-slate-50">
              <a href="<%= n.href || '#' %>" class="block">
                <div class="text-sm font-medium text-slate-900"><%= n.title %></div>
                <div class="text-xs text-slate-500"><%= n.message || '' %></div>
              </a>
            </li>
          <% }) %>
        <% } else { %>
          <li class="p-3 text-sm text-slate-500">Inga nya notiser</li>
        <% } %>
      </ul>
    </div>
  </div>
<% } %>

      <!-- Right side (desktop) -->
      <div class="hidden md:flex items-center gap-2">
        <% if (me) { %>
          <!-- User dropdown -->
          <div class="relative" id="userMenu">
            <button id="userBtn"
                    class="inline-flex items-center gap-2 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2 text-sm text-slate-700 dark:text-slate-100 hover:bg-slate-50 dark:hover:bg-slate-800">
              <span class="inline-flex h-7 w-7 items-center justify-center rounded-full bg-sky-600 dark:bg-red-600 text-white">
                <%= (me.name || 'U')[0].toUpperCase() %>
              </span>
              <span class="hidden sm:block max-w-[160px] truncate"><%= me.name %></span>
              <i class="ti ti-chevron-down text-slate-500 dark:text-slate-400"></i>
            </button>
            <div id="userDrop"
                 class="hidden absolute right-0 mt-2 w-56 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-lg overflow-hidden">
              <div class="px-4 py-3 text-sm">
                <div class="font-medium text-slate-900 dark:text-white truncate"><%= me.name %></div>
                <div class="text-slate-500 dark:text-slate-400"><%= me.email %></div>
              </div>

              <a href="/profile" class="flex items-center gap-2 px-4 py-2.5 text-sm hover:bg-slate-50 dark:hover:bg-white/5">
                <i class="ti ti-user-circle"></i>
                <%= (me.role === 'dealer') ? 'Mina frågor' : 'Profil' %>
              </a>

              <a href="/profile/favorites"
   class="flex items-center gap-2 px-4 py-2.5 text-sm hover:bg-slate-50 dark:hover:bg-white/5">
  <i class="ti ti-bookmark"></i>
  Favoriter
  <% if (typeof meFavoritesCount !== 'undefined') { %>
    <span class="ml-auto inline-flex items-center justify-center rounded-full
                 bg-amber-100 text-amber-800 dark:bg-amber-900/40 dark:text-amber-300
                 text-[11px] px-2 py-0.5 border border-amber-200 dark:border-amber-800">
      <%= meFavoritesCount %>
    </span>
  <% } %>
</a>

              <% if (me.role === 'admin') { %>
                <a href="/admin" class="flex items-center gap-2 px-4 py-2.5 text-sm hover:bg-slate-50 dark:hover:bg-white/5">
                  <i class="ti ti-settings"></i> Adminpanel
                </a>
              <% } %>

              <form action="/api/auth/logout" method="post" onsubmit="return doLogout(event)">
                <button class="w-full text-left flex items-center gap-2 px-4 py-2.5 text-sm text-red-600 dark:text-red-300 hover:bg-red-50 dark:hover:bg-red-500/10">
                  <i class="ti ti-logout-2"></i> Logga ut
                </button>
              </form>
            </div>
          </div>
        <% } else { %>
          <a href="/login" class="px-3 py-2 text-sm rounded-lg border border-slate-300 dark:border-slate-700 text-slate-700 dark:text-slate-100 hover:bg-slate-50 dark:hover:bg-slate-800">Logga in</a>
          <a href="/register" class="inline-flex items-center gap-1 rounded-lg bg-sky-600 dark:bg-red-600 text-white px-3 py-2 text-sm hover:bg-sky-700 dark:hover:bg-red-700">
            <i class="ti ti-user-plus text-base"></i> Skapa konto
          </a>
        <% } %>

        <!-- Theme toggle -->
        <button id="themeToggle"
                class="ml-1 inline-flex h-9 w-9 items-center justify-center rounded-lg border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-white/5 text-slate-700 dark:text-slate-200 transition"
                aria-label="Växla tema">
          <i id="themeIcon" class="ti ti-sun text-lg"></i>
        </button>
      </div>

      <!-- Mobile toggle -->
      <button id="navToggle"
              class="md:hidden ml-1 inline-flex h-10 w-10 items-center justify-center rounded-xl hover:bg-slate-100 dark:hover:bg-white/5">
        <i class="ti ti-menu-2 text-xl text-slate-700 dark:text-slate-100"></i>
      </button>

      <!-- Mobilmeny (dold som default) -->
<nav id="mobileNav"
     class="md:hidden hidden absolute left-0 right-0 top-16 z-40
            border-t border-slate-200 bg-white shadow-lg">
  <div class="px-4 py-3 space-y-1 text-sm">
    <a href="/" class="block px-3 py-2 rounded-lg hover:bg-slate-100">Hem</a>
    <a href="/ask" class="block px-3 py-2 rounded-lg hover:bg-slate-100">Ställ fråga</a>
    <a href="/resources" class="block px-3 py-2 rounded-lg hover:bg-slate-100">Resurser</a>
    <a href="/explore" class="block px-3 py-2 rounded-lg hover:bg-slate-100">Utforska</a>
    <a href="/feedback" class="block px-3 py-2 rounded-lg hover:bg-slate-100">Feedback</a>

    <% if (me && (me.role === 'admin' || me.role === 'support')) { %>
      <a href="/support-questions" class="block px-3 py-2 rounded-lg hover:bg-slate-100">Support</a>
    <% } %>

    <div class="pt-2 border-t border-slate-200 mt-2">
      <% if (me) { %>
        <a href="/profile" class="block px-3 py-2 rounded-lg hover:bg-slate-100">
          <%= (me.role === 'dealer') ? 'Mina frågor' : 'Profil' %>
        </a>
        <a href="/profile/favorites" class="block px-3 py-2 rounded-lg hover:bg-slate-100">
          Favoriter
        </a>
        <% if (me.role === 'admin') { %>
          <a href="/admin" class="block px-3 py-2 rounded-lg hover:bg-slate-100">Adminpanel</a>
        <% } %>
        <form action="/api/auth/logout" method="post" onsubmit="return doLogout(event)">
          <button class="w-full text-left block px-3 py-2 rounded-lg hover:bg-slate-100 text-red-600">
            Logga ut
          </button>
        </form>
      <% } else { %>
        <a href="/login" class="block px-3 py-2 rounded-lg hover:bg-slate-100">Logga in</a>
        <a href="/register" class="block px-3 py-2 rounded-lg hover:bg-slate-100">Skapa konto</a>
      <% } %>
    </div>
  </div>
</nav>
    </div>
  </div>
</header>

<script>
  async function doLogout(e){
    e.preventDefault();
    try { await fetch('/api/auth/logout', { method: 'POST' }); } catch {}
    location.href = '/login';
    return false;
  }

  // User dropdown (desktop)
  (function(){
    const btn  = document.getElementById('userBtn');
    const drop = document.getElementById('userDrop');
    if (!btn || !drop) return;
    btn.addEventListener('click', () => drop.classList.toggle('hidden'));
    document.addEventListener('click', (e) => {
      if (!e.target.closest('#userMenu')) drop.classList.add('hidden');
    });
  })();

  // Theme toggle
  (function(){
    const btn  = document.getElementById('themeToggle');
    const icon = document.getElementById('themeIcon');
    const root = document.documentElement;

    if (localStorage.theme === 'dark') root.classList.add('dark');
    else root.classList.remove('dark');
    syncIcon();

    function syncIcon(){
      const dark = root.classList.contains('dark');
      icon.classList.toggle('ti-sun', !dark);
      icon.classList.toggle('ti-moon', dark);
    }

    btn.addEventListener('click', () => {
      root.classList.toggle('dark');
      localStorage.theme = root.classList.contains('dark') ? 'dark' : 'light';
      syncIcon();
    });
  })();
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const wrap  = document.getElementById('notifWrapper');
  const btn   = document.getElementById('notifBtn');
  const popup = document.getElementById('notifPopup');

  if (btn && popup) {
    btn.addEventListener('click', () => popup.classList.toggle('hidden'));

    document.addEventListener('click', (e) => {
      if (!e.target.closest('#notifWrapper')) popup.classList.add('hidden');
    });

    // stäng popup när man klickar en notis-länk
    popup.addEventListener('click', (e) => {
      const a = e.target.closest('a');
      if (a) popup.classList.add('hidden');
    });
  }
});
</script>

<script>
(() => {
  const btn   = document.getElementById('navToggle');
  const panel = document.getElementById('mobileNav');
  if (!btn || !panel) return;

  const close = () => { panel.classList.add('hidden'); btn.setAttribute('aria-expanded','false'); };
  const open  = () => { panel.classList.remove('hidden'); btn.setAttribute('aria-expanded','true'); };

  btn.setAttribute('aria-controls','mobileNav');
  btn.setAttribute('aria-expanded','false');

  btn.addEventListener('click', () => {
    const isOpen = btn.getAttribute('aria-expanded') === 'true';
    isOpen ? close() : open();
  });

  // Stäng vid klick utanför + ESC
  document.addEventListener('click', (e) => {
    if (!panel.contains(e.target) && !btn.contains(e.target)) close();
  });
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') close(); });
})();
</script>