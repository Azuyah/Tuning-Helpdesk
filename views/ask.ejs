<section class="mx-auto max-w-3xl px-4 py-12">
  <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-800 p-8">
    <h1 class="text-2xl font-bold text-slate-900 dark:text-white mb-6">Ställ en fråga</h1>

    <!-- Statusmeddelande -->
    <div id="msg" class="hidden mb-6"></div>

    <form id="askForm" class="space-y-6">
      <!-- Titel -->
      <div>
        <label for="title" class="block text-sm font-medium text-slate-700 dark:text-slate-300">
          Titel <span class="text-red-500">*</span>
        </label>
        <input type="text" name="title" id="title" required
               class="mt-1 block w-full rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-950 text-slate-900 dark:text-slate-100 px-3 py-2 shadow-sm focus:border-sky-500 focus:ring-sky-500 sm:text-sm"/>
      </div>

      <!-- Beskrivning -->
      <div>
        <label for="body" class="block text-sm font-medium text-slate-700 dark:text-slate-300">
          Beskriv frågan (valfritt)
        </label>
        <textarea name="body" id="body" rows="5"
                  class="mt-1 block w-full rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-950 text-slate-900 dark:text-slate-100 px-3 py-2 shadow-sm focus:border-sky-500 focus:ring-sky-500 sm:text-sm"></textarea>
      </div>

        <!-- Bild (valfritt) -->
  <div>
    <label for="image" class="block text-sm font-medium text-slate-700 dark:text-slate-300">
      Bild (valfritt)
    </label>
    <input type="file" id="image" name="image" accept="image/jpeg,image/png,image/webp"
           class="mt-1 block w-full text-sm text-slate-700 dark:text-slate-300
                  file:mr-4 file:py-2 file:px-4
                  file:rounded-lg file:border-0
                  file:text-sm file:font-semibold
                  file:bg-slate-100 file:text-slate-700
                  hover:file:bg-slate-200" />
    <p class="text-xs text-slate-500 mt-1">Max ~8 MB. Tillåtna format: JPG, PNG, WEBP.</p>

    <!-- Förhandsvisning -->
    <div id="imgPreviewWrap" class="mt-3 hidden">
      <img id="imgPreview" alt="Förhandsvisning"
           class="max-h-48 rounded-lg border border-slate-200 dark:border-slate-700 object-contain" />
    </div>
  </div>

      <!-- Skicka -->
      <div class="pt-2">
        <button id="btnSubmit" type="submit"
                class="w-full sm:w-auto inline-flex items-center justify-center gap-2 rounded-lg bg-sky-600 px-6 py-3 text-white font-semibold shadow hover:bg-sky-700 disabled:opacity-60">
          Skicka
        </button>
      </div>
    </form>
  </div>
</section>

<script>
(function () {
  const form = document.getElementById('askForm');
  const msg  = document.getElementById('msg');
  const btn  = document.getElementById('btnSubmit');
  const fileInput = document.getElementById('image');
  const imgPreviewWrap = document.getElementById('imgPreviewWrap');
  const imgPreview = document.getElementById('imgPreview');

  function showMsg(type, text) {
    msg.className = 'mb-6 rounded-lg px-4 py-3 text-sm ' +
      (type === 'ok'
        ? 'bg-emerald-50 text-emerald-800 border border-emerald-200'
        : 'bg-red-50 text-red-800 border border-red-200');
    msg.textContent = text;
    msg.classList.remove('hidden');
  }

  // Enkel förhandsvisning
  fileInput?.addEventListener('change', () => {
    const f = fileInput.files && fileInput.files[0];
    if (!f) { imgPreviewWrap.classList.add('hidden'); return; }
    const ok = ['image/jpeg','image/png','image/webp'].includes(f.type);
    if (!ok) { showMsg('err','Otillåtet bildformat. Använd JPG/PNG/WEBP.'); fileInput.value=''; return; }
    if (f.size > 8 * 1024 * 1024) { showMsg('err','Filen är för stor (>8 MB).'); fileInput.value=''; return; }
    const url = URL.createObjectURL(f);
    imgPreview.src = url;
    imgPreviewWrap.classList.remove('hidden');
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    msg.classList.add('hidden');
    btn.disabled = true;

    const fd = new FormData(form); // innehåller title, body OCH ev. image

    // Trimma textfält innan vi skickar
    fd.set('title', (fd.get('title') || '').toString().trim());
    fd.set('body',  (fd.get('body')  || '').toString().trim());

    if (!fd.get('title')) {
      showMsg('err', 'Ange en titel.');
      btn.disabled = false;
      return;
    }

    try {
      const res = await fetch('/api/questions', {
        method: 'POST',
        body: fd
        // OBS: Ingen Content-Type header här.
      });

      if (res.status === 401) {
        const params = new URLSearchParams({ next: location.pathname });
        location.href = '/login?' + params.toString();
        return;
      }

      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data.ok) {
        showMsg('err', data.error || 'Kunde inte skicka frågan.');
        btn.disabled = false;
        return;
      }

      // Lyckat
      location.href = '/questions/' + data.id;
    } catch {
      showMsg('err', 'Nätverksfel. Försök igen.');
    } finally {
      btn.disabled = false;
    }
  });
})();
</script>