<section class="mx-auto max-w-3xl px-4 py-12">
  <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-800 p-8">
    <h1 class="text-2xl font-bold text-slate-900 dark:text-white mb-6">Ställ en fråga</h1>

    <!-- Statusmeddelande -->
    <div id="msg" class="hidden mb-6"></div>

    <form id="askForm" class="space-y-6">
      <!-- Titel -->
      <div>
        <label for="title" class="block text-sm font-medium text-slate-700 dark:text-slate-300">
          Titel <span class="text-red-500">*</span>
        </label>
        <input type="text" name="title" id="title" required
               class="mt-1 block w-full rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-950 text-slate-900 dark:text-slate-100 px-3 py-2 shadow-sm focus:border-sky-500 focus:ring-sky-500 sm:text-sm"/>
      </div>

      <!-- Beskrivning -->
      <div>
        <label for="body" class="block text-sm font-medium text-slate-700 dark:text-slate-300">
          Beskriv frågan (valfritt)
        </label>
        <textarea name="body" id="body" rows="5"
                  class="mt-1 block w-full rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-950 text-slate-900 dark:text-slate-100 px-3 py-2 shadow-sm focus:border-sky-500 focus:ring-sky-500 sm:text-sm"></textarea>
      </div>

      <!-- Skicka -->
      <div class="pt-2">
        <button id="btnSubmit" type="submit"
                class="w-full sm:w-auto inline-flex items-center justify-center gap-2 rounded-lg bg-sky-600 px-6 py-3 text-white font-semibold shadow hover:bg-sky-700 disabled:opacity-60">
          Skicka
        </button>
      </div>
    </form>
  </div>
</section>

<script>
  (function () {
    const form = document.getElementById('askForm');
    const msg  = document.getElementById('msg');
    const btn  = document.getElementById('btnSubmit');

    function showMsg(type, text) {
      msg.className = 'mb-6 rounded-lg px-4 py-3 text-sm ' +
        (type === 'ok'
          ? 'bg-emerald-50 text-emerald-800 border border-emerald-200'
          : 'bg-red-50 text-red-800 border border-red-200');
      msg.textContent = text;
      msg.classList.remove('hidden');
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.classList.add('hidden');
      btn.disabled = true;

      const fd = new FormData(form);
      const payload = {
        title: (fd.get('title') || '').trim(),
        body:  (fd.get('body')  || '').trim()
      };
      if (!payload.title) {
        showMsg('err', 'Ange en titel.');
        btn.disabled = false;
        return;
      }

      try {
        const res = await fetch('/api/questions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (res.status === 401) { // ej inloggad
          const params = new URLSearchParams({ next: location.pathname });
          location.href = '/login?' + params.toString();
          return;
        }

        const data = await res.json().catch(() => ({}));

        if (!res.ok || !data.ok) {
          showMsg('err', data.error || 'Kunde inte skicka frågan.');
          btn.disabled = false;
          return;
        }

        // Lyckat: visa bekräftelse och nollställ formuläret (eller redirecta)
        form.reset();
        showMsg('ok', 'Tack! Din fråga är inskickad. Vi hör av oss snart.');
        // Vill du hellre redirecta? Avkommentera nästa rad:
        // location.href = '/'; // eller t.ex. '/admin' för admins
      } catch (err) {
        showMsg('err', 'Nätverksfel. Försök igen.');
      } finally {
        btn.disabled = false;
      }
    });
  })();
</script>