<script>
(() => {
  const $q = document.getElementById('q');
  const $btn = document.getElementById('btnSearch');
  const $box = document.getElementById('suggestBox');

  // Navigera till resultatsida
  function goSearch() {
    const q = ($q.value || '').trim();
    const url = q ? `/search?q=${encodeURIComponent(q)}` : '/search'; // <-- FIX: ingen backtick här
    window.location.href = url;
  }

  // Rendera förslag
  function renderSuggest(rows) {
    if (!rows.length) { $box.classList.add('hidden'); $box.innerHTML = ''; return; }
    $box.innerHTML = rows.map(r => `
      <a href="/topic/${encodeURIComponent(r.id)}"
         class="block px-4 py-3 hover:bg-slate-50">
        <div class="font-medium text-slate-900 line-clamp-1">${escapeHtml(r.title||'')}</div>
        ${r.snippet ? `<div class="text-sm text-slate-600 line-clamp-1">${escapeHtml(r.snippet)}</div>` : ''}
      </a>
    `).join('');
    $box.classList.remove('hidden');
  }

  // Debounce
  let tId = null;
  function debounce(fn, ms=150){ clearTimeout(tId); tId = setTimeout(fn, ms); }

  async function fetchSuggest(q){
    try {
      if (!q) { renderSuggest([]); return; }
      const res = await fetch(`/api/suggest?q=${encodeURIComponent(q)}`);
      const data = await res.json();
      renderSuggest(Array.isArray(data) ? data : []);
    } catch(e) { console.error(e); }
  }

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }

  // Events
  $q.addEventListener('input', () => debounce(() => fetchSuggest($q.value.trim()), 150));
  $q.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); goSearch(); }
    if (e.key === 'Escape') { $box.classList.add('hidden'); }
  });
  $btn.addEventListener('click', goSearch);
  document.addEventListener('click', (e) => {
    if (!e.target.closest('#suggestBox') && e.target !== $q) $box.classList.add('hidden');
  });

  // Klick på ”Populärt”
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.tag-btn');
    if (!btn) return;
    $q.value = btn.getAttribute('data-tag');
    goSearch();
  });
})();
</script>

<!-- Kategorikort / Populärt (egen sektion under hero) -->
<section class="mx-auto max-w-6xl px-4 mt-24 pb-20 relative z-10">
  <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-3">
    <% (categoriesShow || []).forEach(cat => { %>
      <article class="rounded-2xl border border-slate-200 bg-white shadow-sm hover:shadow transition p-6">
        <div class="mb-4">
          <i class="ti <%= cat.icon || 'ti-folder' %> text-4xl text-sky-500"></i>
        </div>
        <h3 class="text-2xl font-semibold text-slate-900 mb-4"><%= cat.title %></h3>

        <ul class="space-y-3">
          <% (cat.items || []).forEach(it => { %>
            <li class="flex items-start gap-3">
              <i class="ti ti-file-description text-slate-400 mt-1"></i>
              <a href="/topic/<%= encodeURIComponent(it.id) %>" class="text-slate-700 hover:text-sky-700">
                <%= it.title %>
              </a>
            </li>
          <% }) %>
        </ul>

        <div class="mt-6">
          <a href="/category/<%= cat.id %>"
             class="inline-flex items-center gap-2 rounded-xl border border-slate-300 px-4 py-2 text-slate-700 hover:border-sky-400">
            Visa alla
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M13.5 4.5 21 12l-7.5 7.5-1.06-1.06 5.69-5.69H3v-1.5h15.13l-5.69-5.69L13.5 4.5Z"/></svg>
          </a>
        </div>
      </article>
    <% }) %>
  </div>
  <!-- Senaste frågor -->
<section class="mx-auto max-w-6xl px-4 py-10">
  <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold text-slate-900 flex items-center gap-2">
        <i class="ti ti-message-question text-sky-600"></i> Senaste frågor
      </h2>
      <a href="/explore?tab=questions" class="text-sky-600 hover:underline text-sm">Visa alla</a>
    </div>

    <% if (!latestQuestions || latestQuestions.length === 0) { %>
      <p class="text-slate-500 text-sm">Inga frågor ännu.</p>
    <% } else { %>
      <ul class="divide-y divide-slate-200">
        <% latestQuestions.forEach(q => { %>
          <li class="py-3 flex items-center justify-between">
            <div class="min-w-0">
              <a href="/questions/<%= q.id %>" class="text-slate-800 hover:text-sky-700 font-medium truncate">
                <%= q.title %>
              </a>
              <div class="text-xs text-slate-500 mt-0.5">
                <%= new Date(q.created_at).toLocaleDateString('sv-SE') %> •
                <% const lbl = q.status==='answered'?'Besvarad': q.status==='closed'?'Stängd':'Öppen'; %>
                <span class="inline-flex items-center gap-1">
                  <span class="w-1.5 h-1.5 rounded-full <%= q.status==='answered'?'bg-emerald-500':q.status==='closed'?'bg-slate-400':'bg-amber-500' %>"></span>
                  <%= lbl %>
                </span>
              </div>
            </div>
            <a href="/questions/<%= q.id %>" class="inline-flex items-center gap-1.5 text-sky-600 text-sm hover:underline">
              Visa <i class="ti ti-arrow-right"></i>
            </a>
          </li>
        <% }) %>
      </ul>
    <% } %>
  </div>
</section>
</section>