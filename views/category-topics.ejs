<!-- views/category-topics.ejs -->
<section class="mx-auto max-w-6xl px-4 py-10">
  <div class="mb-6 flex items-center justify-between gap-3">
    <div>
      <h1 class="text-3xl font-bold text-slate-900 dark:text-white"><%= category.title %></h1>
<p class="text-sm text-slate-500 dark:text-slate-400">
  <%= topics.length %> poster i denna kategori.
</p>
    </div>

    <a href="/admin"
       class="inline-flex items-center gap-2 rounded-lg border border-slate-300 dark:border-slate-700 px-3 py-2 text-sm hover:bg-slate-50 dark:hover:bg-white/5">
      <i class="ti ti-arrow-left"></i> Tillbaka
    </a>
  </div>

  <div class="overflow-x-auto rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 shadow">
    <table class="min-w-[820px] w-full text-left text-sm">
<thead class="bg-slate-50 dark:bg-slate-900/60 border-b border-slate-200 dark:border-slate-800">
  <tr>
    <th class="p-3 font-semibold text-slate-600 dark:text-slate-300 w-28">Typ</th>
    <th class="p-3 font-semibold text-slate-600 dark:text-slate-300">Titel</th>
    <th class="p-3 font-semibold text-slate-600 dark:text-slate-300 w-40">Uppdaterad</th>
    <th class="p-3 font-semibold text-slate-600 dark:text-slate-300 w-[380px] text-right">Åtgärder</th>
  </tr>
</thead>
      <tbody class="[&>tr]:border-b border-slate-200 dark:border-slate-800">
<% if (topics.length === 0) { %>
  <tr><td class="p-4 text-slate-500" colspan="4">Inga poster i denna kategori ännu.</td></tr>
<% } %>

<% topics.forEach(t => { 
     const isQuestion = t.type === 'question';
     const isResource = t.type === 'resource';

     const openHref = isQuestion
       ? `/questions/${t.id}`
       : (isResource ? `/resources/${t.id}` : `/topic/${t.id}`);

     // Flytta/Ta bort endpoints: olika för fråga vs ämne/resurs
     const moveAction = isQuestion
       ? `/admin/categories/${category.id}/questions/${t.id}/move`
       : `/admin/categories/${category.id}/topics/${t.id}/move`;

     const removeAction = isQuestion
       ? `/admin/categories/${category.id}/questions/${t.id}/remove`
       : `/admin/categories/${category.id}/topics/${t.id}/remove`;

     const typeBadge = isQuestion
       ? '<span class="text-[11px] px-2 py-0.5 rounded bg-violet-100 text-violet-700 border border-violet-200">Fråga</span>'
       : (isResource
          ? '<span class="text-[11px] px-2 py-0.5 rounded bg-amber-100 text-amber-700 border border-amber-200">Resurs</span>'
          : '<span class="text-[11px] px-2 py-0.5 rounded bg-sky-100 text-sky-700 border border-sky-200">Ämne</span>');
%>
  <tr class="align-middle">
    <!-- Typ -->
    <td class="p-3"><%- typeBadge %></td>

    <!-- Titel + excerpt -->
    <td class="p-3">
      <div class="font-medium text-slate-900 dark:text-white"><%= t.title %></div>
      <% if (t.excerpt) { %>
        <div class="text-slate-500 dark:text-slate-400 line-clamp-1"><%= t.excerpt %></div>
      <% } %>
    </td>

    <!-- Datum -->
    <td class="p-3 text-slate-500 dark:text-slate-400">
      <%= new Date(t.updated_at).toLocaleDateString('sv-SE') %>
    </td>

    <!-- Åtgärder -->
<td class="p-3 text-right">
  <div class="inline-flex flex-wrap items-center gap-2 relative justify-end">
    <a href="<%= openHref %>"
       class="inline-flex items-center gap-1.5 rounded-lg border border-slate-300 dark:border-slate-700 px-3 py-2 hover:bg-slate-50 dark:hover:bg-white/5">
      <i class="ti ti-eye"></i> Öppna
    </a>

    <div class="relative">
      <button type="button"
              class="moveBtn inline-flex items-center gap-1.5 rounded-lg bg-sky-600 text-white px-3 py-2 hover:bg-sky-700">
        <i class="ti ti-arrows-exchange"></i> Flytta
      </button>

      <div class="moveMenu hidden absolute right-0 z-20 mt-2 w-64 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-lg">
        <div class="px-3 py-2 text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Flytta till…</div>
        <div class="border-t border-slate-200 dark:border-slate-800"></div>

        <% if (otherCats.length === 0) { %>
          <div class="px-3 py-3 text-slate-500 dark:text-slate-400 text-sm">Inga andra kategorier.</div>
        <% } else { %>
          <% otherCats.forEach(c => { %>
            <form method="POST" action="<%= moveAction %>">
              <input type="hidden" name="newCategoryId" value="<%= c.id %>">
              <button class="w-full text-left px-3 py-2 text-sm hover:bg-slate-50 dark:hover:bg-white/5">
                <i class="ti ti-folder text-slate-500 mr-2"></i><%= c.title %>
              </button>
            </form>
          <% }) %>
        <% } %>
      </div>
    </div>
  </div>
</td>
  </tr>
<% }) %>
      </tbody>
    </table>
  </div>
</section>

<script>
(function () {
  // Skapa portal behållare en gång
  const PORTAL_ID = 'moveMenuPortal';
  let portal = document.getElementById(PORTAL_ID);
  if (!portal) {
    portal = document.createElement('div');
    portal.id = PORTAL_ID;
    portal.style.position = 'fixed';
    portal.style.zIndex = '10000';
    portal.style.inset = '0 auto auto 0'; // så vi kan sätta left/top
    portal.style.pointerEvents = 'none';   // portaln fångar inte klick
    document.body.appendChild(portal);
  }

  const rows = Array.from(document.querySelectorAll('.moveBtn'));
  const openState = { menu: null, originWrap: null };

  function closeAll() {
    if (!openState.menu) return;
    // göm och lägg tillbaka menyn i sin originella wrapper
    openState.menu.classList.add('hidden');
    openState.menu.style.position = '';
    openState.menu.style.left = '';
    openState.menu.style.top = '';
    openState.menu.style.pointerEvents = '';
    if (openState.originWrap) openState.originWrap.appendChild(openState.menu);
    openState.menu = null;
    openState.originWrap = null;
    window.removeEventListener('resize', closeAll);
    window.removeEventListener('scroll', closeAll, true);
  }

  function openMenu(btn) {
    const wrap = btn.closest('.relative') || btn.parentElement;
    const menu = wrap.querySelector('.moveMenu');
    if (!menu) return;

    // Stäng ev. annan meny
    closeAll();

    // flytta menyn till portal
    openState.menu = menu;
    openState.originWrap = wrap;

    // tillåt klick i menyn
    menu.style.pointerEvents = 'auto';

    // visa tillfälligt för att mäta storlek
    menu.classList.remove('hidden');
    menu.style.visibility = 'hidden';
    menu.style.position = 'fixed';
    portal.appendChild(menu);

    const rect = btn.getBoundingClientRect();
    const gap = 8;

    // räkna ut placering
    const vw = window.innerWidth;
    const menuW = menu.offsetWidth || 256;
    const menuH = menu.offsetHeight || 1;

    let left = rect.left;
    let top  = rect.bottom + gap;

    // om den går utanför högerkant, justera vänster
    if (left + menuW > vw - 12) left = Math.max(12, vw - 12 - menuW);

    // om den går under botten (ovanligt här), lägg ovanför knappen
    const maxBottom = window.innerHeight - 12;
    if (top + menuH > maxBottom) top = Math.max(12, rect.top - gap - menuH);

    // applicera
    menu.style.left = left + 'px';
    menu.style.top  = top  + 'px';
    menu.style.visibility = 'visible';

    // stäng vid resize/scroll/klick utanför
    window.addEventListener('resize', closeAll);
    window.addEventListener('scroll', closeAll, true);
  }

  rows.forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const isSame = openState.menu && btn.closest('.relative')?.contains(openState.menu);
      if (isSame && !openState.menu.classList.contains('hidden')) {
        closeAll();
      } else {
        openMenu(btn);
      }
    });
  });

  document.addEventListener('click', (e) => {
    // stäng om klick inte är i en meny eller på en moveBtn
    if (e.target.closest('.moveMenu') || e.target.closest('.moveBtn')) return;
    closeAll();
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeAll();
  });
})();
</script>